<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            position: relative;
            box-sizing: border-box;
            font-family: sans-serif;
            font-size: 16px;
        }

        body {
            display: grid;
            grid-template-areas: "header header header" "left main right" "footer footer footer";
            grid-template-columns: 1fr 3fr 0;
            grid-template-rows: 50px 1fr 50px;
            width: 100%;
            height: 100vh;
        }

        h1 {
            font-size: 28px;
        }

        h2 {
            font-size: 24px;
        }

        h3 {
            font-size: 20px;
        }

        header {
            background: darkcyan;
            grid-area: header;
        }

        #left {
            grid-area: left;
            background: bisque;
        }

        main {
            grid-area: main;
            background: darkgrey;
            display: grid;
            grid-template-areas: "messages" "input";
            grid-template-rows: 1fr 150px;
        }

        #right {
            grid-area: right;
            background: burlywood;
        }

        footer {
            grid-area: footer;
            background: darkkhaki;
        }

        .channels {

        }

        .channels li {
            cursor: pointer;
        }

        .channels li.active {
            font-weight: bold;
            color: red;
        }

        #channel-input {
            padding: 10px;
            display: block;
            border: 0;
        }
    </style>
</head>
<body>
<header>
    HEADER
</header>

<aside id="left">
    <h3>Channels</h3>
    <ul class="channels"></ul>
</aside>

<main>
    <div id="channel-messages">CHANNEL MESSAGES</div>
    <textarea id="channel-input">Hello world!</textarea>
</main>

<aside id="right">

</aside>

<footer>
    FOOTER
</footer>

<script>
    let token = localStorage.getItem('token');

    if(!token) {
        token = "51e8a6109f115d9f6c39d4e0d134f0363fec3335cff5081a6d39ac85007c9215";
        localStorage.setItem('token', token);
    }

    let socket = new WebSocket("ws://localhost:8924/socket");
    let currentChannel = null;
    let currentThread = null;
    let currentUser = null;
    let messagesChannel = {};
    let messagesThread = {};
    let channelMessageInput = document.querySelector("#channel-input");
    let channelMessagesNode = document.querySelector('#channel-messages');

    document.onclick = function (ev) {
        switch (ev.target.dataset.type) {
            case "channel":
                let id = ev.target.dataset.id;
                setChannelActive(id);
                break;
        }
    }

    // Отправка сообщения в канал по нажанию клавиши Enter
    document.querySelector("#channel-input").onkeyup = function (ev) {
        if (ev.keyCode === 13) {
            sendChannelMessage();
        }
    }

    function setChannelActive(id) {
        let el = document.querySelector(`[data-type='channel'][data-id='${id}']`);

        currentChannel = id;
        currentThread = null;
        currentUser = null;

        document.querySelectorAll("[data-type='channel']").forEach((v) => {
            v.classList.remove('active');
        });

        el.classList.add('active');
        loadChannelMessages(id);
    }

    // Функция отправки сообщения в канал
    function sendChannelMessage() {
        let message = channelMessageInput.value;

        channelMessageInput.value = null;

        socket.send(JSON.stringify({
            type: "MESSAGE",
            target: "CHANNEL",
            id: parseInt(currentChannel),
            value: message,
        }));
    }

    // Загрузка сообщений выбранного канала в <main>
    function loadChannelMessages(id) {
        if (messagesChannel[id] === undefined) {
            socket.send(JSON.stringify({
                type: "REQUEST",
                target: "CHANNEL_MESSAGES",
                id: parseInt(id),
            }));
        } else {
            let channelMessages = document.querySelector('#channel-messages');

            channelMessages.innerHTML = null;

            messagesChannel[id].forEach((v) => {
                loadChannelMessage(v);
            });
        }
    }

    function loadChannelMessage(message) {
        channelMessagesNode.innerHTML += `<div>USER_ID: ${message.user_id} | MESSAGE: ${message.value}</div>`;
    }

    function addChannelMessage(message) {
        console.log('XXX', message);
        messagesChannel[message.id].push(message);
        loadChannelMessage(message);
    }

    socket.onopen = function (ev) {
        console.log("OPEN");

        socket.send(JSON.stringify({
            type: "AUTH",
            token: token,
        }));
    };

    socket.onmessage = function (ev) {
        console.log(ev.data);

        let msg = JSON.parse(ev.data);

        if (msg.type == 'SUCCESS' && msg.target == 'AUTH') {
            socket.send(JSON.stringify({
                type: "REQUEST",
                target: "CHANNEL_LIST",
            }));
        }

        if (msg.type == "RESPONSE" && msg.target == "CHANNEL_LIST") {
            let channels = document.querySelector(".channels");
            channels.innerHTML = null

            msg.data.forEach(function (v) {
                channels.innerHTML += `<li data-type="channel" data-id="${v.id}">${v.title}</li>`;
            });

            //@TODO Debug
            setChannelActive(1);
        }

        if (msg.type == "RESPONSE" && msg.target == "CHANNEL_MESSAGES") {
            messagesChannel[msg.id] = [];

            // @TODO
            msg.data.reverse().forEach((v) => {
                messagesChannel[msg.id].push(v);
            });

            loadChannelMessages(msg.id);
        }

        if (msg.type == "MESSAGE" && msg.target == "CHANNEL") {
            addChannelMessage(msg);
        }
    };

    socket.onclose = function (ev) {
        if (ev.wasClean) {
            console.log("CLOSED CLEAN");
        } else {
            console.log("CLOSED NOT CLEAN");
        }
    };

    socket.onerror = function (e) {
        console.log("ERROR: " + e.message);
    };
</script>
</body>
</html>